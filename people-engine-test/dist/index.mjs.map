{"version":3,"file":"index.mjs","sources":["../src/index.mjs"],"sourcesContent":["// import jwt from \"@tsndr/cloudflare-worker-jwt\";\nconst corsHeaders = {\n  \"content-type\": \"application/json;charset=UTF-8\",\n  \"Access-Control-Allow-Origin\": \"*\",\n  \"Access-Control-Allow-Methods\": \"GET,HEAD,POST,OPTIONS\",\n  \"Access-Control-Allow-Headers\": \"*\",\n}\n// Worker\nexport default {\n  async fetch(request, env) {\n    return await handleRequest(request, env);\n  }\n}\nasync function handleRequest(request, env) {\n  try {\n    const upgradeHeader = request.headers.get(\"Upgrade\")\n    if (!upgradeHeader || upgradeHeader !== \"websocket\") {\n      return new Response(\"Expected Upgrade: websocket\", { status: 426 })\n    }\n    let id = env.PEOPLE.idFromName(\"Meeting Hall\");\n    let obj = env.PEOPLE.get(id);\n    let response = await obj.fetch(request);\n    return response;\n  } catch(error) {\n    return new Response(error.message, {\n      status: 200,\n    })\n  }\n}\n// Durable Object\nexport class People {\n  constructor(state, env) {\n    this.state = state;\n    this.people = {};\n    this.kd = {};\n    this.structures = {};\n    this.state.blockConcurrencyWhile(async () => {\n        let stored_structures= await this.state.storage.get(\"structures\");\n        this.structures = stored_structures || {};\n        // let stored_sessions= await this.state.storage.get(\"sessions\");\n        // this.sessions = stored_sessions || [];\n        // let stored_people= await this.state.storage.get(\"people\");\n        // this.people = stored_people || {};\n        let stored_kd= await this.state.storage.get(\"kd\");\n        this.kd = stored_kd || {};\n    })\n  }\n  // Handle HTTP requests from clients.\n  async fetch(request) {\n    // let auth_email=false,decoded=false;\n    // const url = new URL(request.url)\n    // let jwt_token = url.searchParams.get(\"token\");\n    // try {\n    //   let isValid = await jwt.verify(jwt_token,USER_PW_SECRET);\n    //   if(!isValid) {\n    //     return new Response(\"Invalid Token\", {\n    //       headers: corsHeaders,\n    //       status: 403,\n    //     })\n    //   }\n    //   decoded = await jwt.decode(jwt_token);\n    //   auth_email = decoded.email;\n    // } catch(err) {\n    //   return new Response(err.message, {\n    //     headers: corsHeaders,\n    //     status: 403,\n    //   })\n    // }\n    const webSocketPair = new WebSocketPair()\n    const [client, server] = Object.values(webSocketPair)\n    let webSocket = server\n    webSocket.accept()\n    let session = {webSocket};\n    let receivedUserInfo = false;\n    this.sessions.push(session);\n    webSocket.addEventListener(\"message\", async msg => {\n      if (session.quit) {\n        webSocket.close(1011, \"WebSocket broken.\");\n        delete this.people[session.uid];\n        return;\n      }\n      let data = JSON.parse(msg.data);\n      if(data.update_position) {\n        this.people[data.update_position.uid].position = data.update_position.position;\n        this.broadcast(JSON.stringify(data));\n        return;\n      }\n      // if(data.save_position) {\n      //   await PEOPLE_DATA.put(data.save_position.user.email,JSON.stringify(data.save_position.user));\n      //   return;\n      // }\n      if(data.build_structure) {\n        let structure = {\n          uid: data.build_structure.uid,\n          player: data.build_structure.player_uid,\n          pos: data.build_structure.pos,\n        };\n        this.structures[structure.uid] = structure;\n        this.broadcast(JSON.stringify({add_structure:structure}),session.uid);\n        return;\n      }\n      if(data.destroy_structure) {\n        delete this.structures[data.destroy_structure.uid];\n        this.broadcast(JSON.stringify({destroy_structure:data.destroy_structure}),session.uid);\n        return;\n      }\n      if(data.build_bullet) {\n        let bullet = {\n          uid: data.build_bullet.uid,\n          player_uid: data.build_bullet.player_uid,\n          player_uid: data.build_bullet.player_uid,\n          pos: data.build_bullet.pos,\n          move: data.build_bullet.move,\n        };\n        this.broadcast(JSON.stringify({add_bullet:bullet}),session.uid);\n        return;\n      }\n      if(data.player_hit) {\n        let shooter = data.player_hit.shooter;\n        let hit = data.player_hit.hit;\n        let kill =  {\n          timestampe: Date.now(),\n          player: hit.uid,\n        }\n        if(!this.kd[shooter.uid]) {\n          this.kd[shooter.uid] = {\n            name: shooter.name,\n            kills: [kill],\n            deaths: [],\n          };\n        }else{\n          this.kd[shooter.uid].kills.push(kill)\n        }\n        if(!this.kd[hit.uid]) {\n          this.kd[hit.uid] = {\n            name: hit.name,\n            kills: [],\n            deaths: [kill],\n          };\n        }else{\n          this.kd[hit.uid].deaths.push(kill)\n        }\n        this.broadcast(JSON.stringify({kill:data.player_hit}));\n        this.broadcast(JSON.stringify({kd_update:this.kd}));\n        return;\n      }\n      if(!receivedUserInfo){\n        session.name = \"\" + (data.name || \"anonymous\");\n        session.uid = data.uid;\n        if(!data.position) data.position = {x:50,y:50};\n        // if(!data.position) {\n        //   if(this.people[uid] && this.people[uid].position) {\n        //     data.position = this.people[uid].position;\n        //   }else{\n        //     data.position = {x:50,y:50};\n        //   }\n        // }\n        this.people[data.uid] = data;\n        this.broadcast(JSON.stringify({joined: data}));\n        webSocket.send(JSON.stringify({people: this.people}));\n        webSocket.send(JSON.stringify({structures: this.structures}));\n        webSocket.send(JSON.stringify({kd_update: this.kd}));\n        receivedUserInfo = true;\n        return new Response(null, {\n          status: 101,\n          webSocket: client\n        })\n      }\n      data = { name: session.name, message: \"\" + data.message };\n      data.timestamp = Math.max(Date.now(), this.lastTimestamp + 1);\n      this.lastTimestamp = data.timestamp;\n      let dataStr = JSON.stringify(data);\n      this.broadcast(dataStr);\n    })\n    let closeOrErrorHandler = async (evt) => {\n      await this.state.storage.put(\"structures\", this.value);\n      //await this.state.storage.put(\"sessions\", this.value);\n      //await this.state.storage.put(\"people\", this.value);\n      await this.state.storage.put(\"kd\", this.value);\n      session.quit = true;\n      this.sessions = this.sessions.filter(member => member !== session);\n      if (session.name) {\n        this.kd[session.uid].name = session.name;\n        this.broadcast(JSON.stringify({quit: session}));\n        delete this.people[session.uid];\n      }\n    };\n    webSocket.addEventListener(\"close\", closeOrErrorHandler);\n    webSocket.addEventListener(\"error\", closeOrErrorHandler);\n    return new Response(null, {\n      // headers: {\n      //   \"ERRORLOG\": auth_email\n      // },\n      status: 101,\n      webSocket: client\n    })\n  }\n  broadcast(message,others = false) {\n    if (typeof message !== \"string\") {\n      message = JSON.stringify(message);\n    }\n    let quitters = [];\n    this.sessions = this.sessions.filter(session => {\n      try {\n        if(others && session.uid != others) {\n          session.webSocket.send(message);\n        }\n        if(!others) {\n          session.webSocket.send(message);\n        }\n        return true;\n      } catch (err) {\n        session.quit = true;\n        quitters.push(session);\n        return false;\n      }\n    });\n    quitters.forEach(quitter => {\n      this.broadcast({quit: quitter});\n    });\n  }\n\n}\n"],"names":["async","request","env","upgradeHeader","headers","get","Response","status","id","PEOPLE","idFromName","obj","fetch","error","message","handleRequest","People","constructor","state","this","people","kd","structures","blockConcurrencyWhile","stored_structures","storage","stored_kd","webSocketPair","WebSocketPair","client","server","Object","values","webSocket","accept","session","receivedUserInfo","sessions","push","addEventListener","quit","close","uid","data","JSON","parse","msg","update_position","position","broadcast","stringify","build_structure","structure","player","player_uid","pos","add_structure","destroy_structure","build_bullet","bullet","move","add_bullet","player_hit","shooter","hit","kill","timestampe","Date","now","kills","name","deaths","kd_update","x","y","joined","send","timestamp","Math","max","lastTimestamp","dataStr","closeOrErrorHandler","evt","put","value","filter","member","others","quitters","err","forEach","quitter"],"mappings":"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"}